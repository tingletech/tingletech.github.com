<!DOCTYPE html>  <html> <head>   <title>TheJit.groovy</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               TheJit.groovy             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">cdlib</span><span class="o">.</span><span class="na">snac</span><span class="o">.</span><span class="na">kibbles</span><span class="o">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The Jit in this case = <a href="http://thejit.org/">javascript infovis toolkit</a>; not 
just in time compiler</p>

<p>The JSON this produces is used by this HTML/js</p>

<ul>
<li><a href="http://code.google.com/p/xtf-cpf/source/browse/cpf2html/snac-jit.html?name=xtf-cpf"><code>snac-jit.html</code></a></li>
<li><a href="http://code.google.com/p/xtf-cpf/source/browse/cpf2html/snac-jit.js?name=xtf-cpf"><code>snac-jit.js</code></a></li>
<li>the HTML/js is based on <a href="http://thejit.org/static/v20/Jit/Examples/RGraph/example1.html">this example</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kn">import</span> <span class="nn">com.tinkerpop.blueprints.pgm.Edge</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.tinkerpop.blueprints.pgm.Graph</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.tinkerpop.blueprints.pgm.Vertex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.tinkerpop.rexster.extension.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.tinkerpop.rexster.RexsterResourceContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.codehaus.jettison.json.JSONObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.codehaus.jettison.json.JSONArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.tinkerpop.gremlin.groovy.Gremlin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.ws.rs.core.Response</span><span class="o">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>example URL</p>

<ul>
<li><code>/rex/snac/vertices/26460/snac/theJit</code></li>
<li><code>{servlet}/{graph}/vertices/{id}/snac/theJit</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nd">@ExtensionNaming</span><span class="o">(</span><span class="n">namespace</span> <span class="o">=</span> <span class="s2">&quot;snac&quot;</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;theJit&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TheJit</span> <span class="kd">extends</span> <span class="n">AbstractRexsterExtension</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">Gremlin</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@ExtensionDefinition</span><span class="o">(</span><span class="n">extensionPoint</span> <span class="o">=</span> <span class="n">ExtensionPoint</span><span class="o">.</span><span class="na">VERTEX</span><span class="o">)</span>
    <span class="nd">@ExtensionDescriptor</span><span class="o">(</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;JSON needed for graphs in the JavaScript InfoVis Toolkit&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ExtensionResponse</span> <span class="nf">evaluate</span><span class="o">(</span><span class="nd">@RexsterContext</span> <span class="n">RexsterResourceContext</span> <span class="n">context</span><span class="o">,</span>
                                      <span class="nd">@RexsterContext</span> <span class="n">Vertex</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><a href="http://thejit.org/static/v20/Docs/files/Loader/Loader-js.html">JSON format</a></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">JSONArray</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONArray</span><span class="o">();</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>popular graph neighbors get aggregated into this array</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kt">def</span> <span class="n">neighbors</span> <span class="o">=</span> <span class="o">[];</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>collect neighbors; sorted by "popularity"
.score was precomputed with: <code>for (z in g.V ) { z.score = z.out.count() }</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">v</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">dedup</span><span class="o">.</span><span class="na">sort</span><span class="o">{-</span><span class="n">it</span><span class="o">.</span><span class="na">score</span><span class="o">}.</span><span class="na">_</span><span class="o">()[</span><span class="mi">0</span><span class="o">..</span><span class="mi">49</span><span class="o">].</span><span class="na">aggregate</span><span class="o">(</span><span class="n">neighbors</span><span class="o">).</span><span class="na">iterate</span><span class="o">();</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>add JSON for the "center" node to the output array first</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">output</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">buildNode</span><span class="o">(</span><span class="n">v</span><span class="o">,</span> <span class="n">neighbors</span><span class="o">));</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>for each popular graph neighbor; build neighbors JSON and add to output array</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">neighbors</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">output</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">buildNode</span><span class="o">(</span><span class="n">it</span><span class="o">,</span> <span class="n">neighbors</span><span class="o">));</span> <span class="o">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>return the results</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="k">new</span> <span class="nf">ExtensionResponse</span><span class="o">(</span><span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">output</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>build the JSON for the node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">private</span> <span class="nf">buildNode</span><span class="o">(</span><span class="n">vertex</span><span class="o">,</span> <span class="n">neighbors</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONObject</span><span class="o">();</span>
        <span class="n">node</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s2">&quot;id&quot;</span><span class="o">,</span> <span class="n">vertex</span><span class="o">.</span><span class="na">id</span> <span class="k">as</span> <span class="n">String</span><span class="o">);</span>
        <span class="n">node</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s2">&quot;name&quot;</span><span class="o">,</span> <span class="n">vertex</span><span class="o">.</span><span class="na">identity</span><span class="o">);</span>
        <span class="n">node</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s2">&quot;adjacencies&quot;</span><span class="o">,</span> <span class="n">buildAdjacencies</span><span class="o">(</span><span class="n">vertex</span><span class="o">,</span> <span class="n">neighbors</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
    <span class="o">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>build array of adjacent nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">private</span> <span class="nf">buildAdjacencies</span><span class="o">(</span><span class="n">vertex</span><span class="o">,</span> <span class="n">neighbors</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">JSONArray</span> <span class="n">collect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JSONArray</span><span class="o">();</span>
        <span class="kt">def</span> <span class="n">self</span> <span class="o">=</span> <span class="o">[];</span>
        <span class="n">vertex</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">self</span><span class="o">).</span><span class="na">iterate</span><span class="o">();</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>the graph visualization would explode if we loaded all 
the neighbors of all the neighbors, so do this to seach 
for relationships this neighbor has with the other
popular neighbors of the subject we are centered on</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">vertex</span><span class="o">.</span><span class="na">both</span><span class="o">.</span><span class="na">dedup</span><span class="o">().</span><span class="na">retain</span><span class="o">(</span><span class="n">neighbors</span><span class="o">).</span><span class="na">except</span><span class="o">(</span><span class="n">self</span><span class="o">).</span><span class="na">each</span> <span class="o">{</span>
            <span class="n">collect</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">id</span> <span class="k">as</span> <span class="n">String</span><span class="o">);</span>
        <span class="o">};</span>
        <span class="k">return</span> <span class="n">collect</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 